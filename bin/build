#!/bin/bash
#
# $Info: Invoke cmake/make in build directory if present and generate logfile. $
# $Syntax: build [OPTIONS] TARGET $
# $Options: -d => debug mode; -gdb => invoke with gdb; -run => execute after compile; -v => verbose compile

# Check for proper environment
let error_count=0
function Error() {
  echo "ERROR: $@" 1>&2
  let error_count++
}
for var in SYSTEMC PROJ_ROOT CXX CC CMAKE_MODULE_PATH; do
  perl -e 'exit (not exists $ENV{"$ARGV[0]"})' $var ||\
    Error "Missing definition of \$$var."
done
sc_ver_file="$SYSTEMC/include/sysc/kernel/sc_ver.h"
if [[ ! -r $sc_ver_file ]]; then
  Error "SYSTEMC does not refer to a proper installation."
fi
if [[ error_count -gt 0 ]]; then
  echo "Please fix errors and retry."
  exit 1
fi

# Setup option defaults
HERE=$(/bin/pwd)
TARGET="platform" # default
CMAKE_OPTS=""
MAKE_OPTS=""
RUN_OPTS=""
ARGS=""
RUN=0
CLEAN=0
GDBP=""
# If name of script is run...
if [[ $0 =~ .*run ]]; then
  RUN=1
fi

printf "|\n|\n|\n"
clear;
ruler '*'
header -uc "$TARGET"

# Scan command-line for option overrides
while [[ "$1" =~ -.* ]]; do
  if [[ "$1" == "-v" ]]; then
    MAKE_OPTS="${MAKE_OPTS} VERBOSE=1"
    shift
  elif [[ "$1" == "-norun" ]]; then
    RUN=1
    shift
  elif [[ "$1" == "-run" ]]; then
    RUN=1
    shift
  elif [[ "$1" == "-clean" ]]; then
    CLEAN=1
    shift
  elif [[ "$1" == "-gdb" ]]; then
    RUN=1
    GDBP=gdb
    shift
  elif [[ "$1" == "-d" ]]; then
    CMAKE_OPTS="${CMAKE_OPTS} -DCMAKE_BUILD_TYPE=Debug"
    RUN_OPTS="${RUN_OPTS} -debug"
    shift
  elif [[ "$1" == "-a" ]]; then
    shift
    ARGS="$ARGS $1"
    shift
  else
    break
  fi
done
if [[ $# > 0 ]]; then
  TARGET="$1"
  shift
else
  echo "INFO: Using default target - $TARGET"
fi

# Move into build directory if present (recommended)
RDIR="."
BDIR="."
if [[ -r build ]]; then
  RDIR=".."
  BDIR="build"
  echo "cd $BDIR"
  cd $BDIR
fi

# Build
rm -f make.log run.log $RDIR/make.log $RDIR/run.log
if [[ -r $RDIR/CMakeLists.txt ]]; then
  echo "cmake ${CMAKE_OPTS}$RDIR 2>&1 | tee -a make.log"
  cmake "${CMAKE_OPTS}" $RDIR
fi
if [[ $CLEAN == 1 ]]; then
  echo "make clean 2>&1 | tee -a $RDIR/make.log"
  make clean 2>&1 | tee -a $RDIR/make.log
fi
if [[ -x $TARGET ]]; then rm $TARGET; fi
echo "make $TARGET ${MAKE_OPTS} 2>&1 | tee -a $RDIR/make.log"
make $TARGET ${MAKE_OPTS} 2>&1 | tee -a $RDIR/make.log

# Run
if [[ $RUN == 1 ]]; then
cd $RDIR
env DEBUG=1\
    LD_LIBRARY_PATH=$SYSTEMC/lib \
    DYLD_LIBRARY_PATH=$SYSTEMC/lib \
  $GDBP $BDIR/$TARGET -- $RUN_OPTS ${ARGS} 2>&1 \
  | tee $BDIR/run.log

  if [[ "$RDIR" != "$BDIR" ]]; then
    filter-sclog <$BDIR/run.log >$RDIR/run.log;
  else
    filter-sclog <$RDIR/run.log >$RDIR/run2.log;
    rm $BDIR/run.log
    mv $BDIR/run2.log $RDIR/run.log
  fi
fi

# The end
